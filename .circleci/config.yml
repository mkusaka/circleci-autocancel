version: 2.1

executors:
  node:
    docker:
      - image: cimg/node:22.18
    working_directory: ~/repo

jobs:
  # Autocancel job - runs first to cancel redundant workflows
  autocancel:
    executor: node
    steps:
      - checkout
      - run:
          name: Install pnpm
          command: |
            corepack enable
            corepack prepare pnpm@latest --activate
      - run:
          name: Install dependencies
          command: pnpm install --frozen-lockfile
      - run:
          name: Build project
          command: pnpm run build
      - run:
          name: Test autocancel in dry-run mode
          command: |
            echo "Testing autocancel with dry-run..."
            node dist/cli.js --dry-run --verbose || echo "Expected to fail without proper env vars"
      - run:
          name: Run autocancel (actual)
          command: |
            echo "Running autocancel for real..."
            # This will cancel older workflows on the same branch
            node dist/cli.js --verbose --max-pages 2 --sleep-ms 200 || true
      # Save the built package for other jobs
      - persist_to_workspace:
          root: .
          paths:
            - dist
            - node_modules

  test:
    executor: node
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Run tests
          command: pnpm test

  lint:
    executor: node
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Run linter
          command: pnpm run lint
      - run:
          name: Check formatting
          command: pnpm run format:check

  typecheck:
    executor: node
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Type check
          command: pnpm run typecheck

  integration_test:
    executor: node
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Test CLI help
          command: |
            node dist/cli.js --help
      - run:
          name: Test library import
          command: |
            cat > test-import.mjs << 'EOF'
            import { autocancel } from './dist/index.js';
            console.log('Library import successful:', typeof autocancel === 'function');
            EOF
            node test-import.mjs

workflows:
  version: 2

  test_and_build:
    jobs:
      # Run autocancel first to cancel any redundant workflows
      - autocancel:
          context:
            - circleci-api # Expects CIRCLECI_TOKEN in context

      # Then run the actual tests in parallel
      - test:
          requires:
            - autocancel
      - lint:
          requires:
            - autocancel
      - typecheck:
          requires:
            - autocancel
      - integration_test:
          requires:
            - autocancel

  # Workflow to test multiple pushes (for autocancel testing)
  test_multiple_pushes:
    jobs:
      - autocancel:
          context:
            - circleci-api
          filters:
            branches:
              only:
                - main
                - develop
                - /feature\/.*/
      - test:
          requires:
            - autocancel
          # Add artificial delay to make workflows longer (for testing autocancel)
          post-steps:
            - run:
                name: Artificial delay for testing
                command: |
                  echo "Simulating long-running job..."
                  sleep 30
