version: 2.1

executors:
  node:
    docker:
      - image: cimg/node:22.18
    working_directory: ~/repo

jobs:
  # Autocancel job - runs first to cancel redundant workflows
  autocancel:
    executor: node
    steps:
      - checkout
      - run:
          name: Install pnpm
          command: |
            corepack enable
            corepack prepare pnpm@latest --activate
      - run:
          name: Install dependencies
          command: pnpm install --frozen-lockfile
      - run:
          name: Build project
          command: pnpm run build
      - run:
          name: Run autocancel
          command: |
            echo "========================================="
            echo "Running autocancel for workflow: $CIRCLE_WORKFLOW_ID"
            echo "Pipeline: $CIRCLE_PIPELINE_ID"
            echo "Branch: $CIRCLE_BRANCH"
            echo "========================================="
            # This will cancel older workflows on the same branch
            # Using debug mode for detailed logging
            DEBUG=* node dist/cli.js --verbose --max-pages 3 --sleep-ms 500 || true

  slow_job:
    executor: node
    steps:
      - checkout
      - run:
          name: Start slow job
          command: |
            echo "Starting slow job at $(date)"
            echo "This job will run for 60 seconds to test autocancel..."
            echo "Pipeline: $CIRCLE_PIPELINE_ID"
            echo "Workflow: $CIRCLE_WORKFLOW_ID"
      - run:
          name: Simulate long-running task
          command: |
            for i in {1..60}; do
              echo "Progress: $i/60 seconds..."
              sleep 1
            done
            echo "Slow job completed at $(date)"

workflows:
  version: 2

  autocancel_test:
    jobs:
      # Run autocancel first to cancel any redundant workflows
      - autocancel:
          context:
            - circleci-api # Expects CIRCLECI_TOKEN in context
      
      # Then run a slow job that can be cancelled
      - slow_job:
          requires:
            - autocancel
